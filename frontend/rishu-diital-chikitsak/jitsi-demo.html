<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Jitsi Demo – Prejoin + Embed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Jitsi IFrame API -->
  <script src="https://meet.jit.si/external_api.js"></script>
  <style>
    :root { --bg:#0b0c10; --panel:#14161a; --ink:#e8e8ea; --muted:#9aa0a6; --accent:#6ee7ff; --danger:#ff4d4f; --ok:#34d399; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display:grid; gap:16px; grid-template-columns: 380px 1fr; }
    .card { background:var(--panel); border:1px solid #1e2229; border-radius:16px; padding:16px; box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: 24px; font-weight: 800; letter-spacing: .2px; }
    h2 { margin: 8px 0 12px; font-size: 16px; color: var(--muted); font-weight: 600; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input[type="text"], select {
      width:100%; background:#0f1115; color:var(--ink); border:1px solid #232833; border-radius:10px; padding:10px 12px; outline:none;
    }
    .row { display:flex; gap:8px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid #2a2f3a; background:#10131a; color:var(--ink);
      cursor:pointer; user-select:none; transition:.15s transform ease, .15s background ease, .15s border-color ease;
    }
    .btn:hover { transform: translateY(-1px); border-color:#394357; }
    .btn.primary { background: linear-gradient(135deg, #0b2c36, #142d33); border-color:#234a5a; }
    .btn.good { border-color:#1f3b2f; background:#0f1b16; }
    .btn.danger { border-color:#3a2222; background:#1a0f10; }
    .btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }
    .toggles { display:flex; gap:8px; flex-wrap: wrap; margin-top: 8px; }
    .chip {
      background:#0f1115; border:1px solid #2a2f3a; color:var(--ink); padding:8px 10px; border-radius:999px; display:inline-flex; gap:6px; align-items:center; cursor:pointer;
    }
    .chip input { margin-right:6px; }
    .hint { font-size:12px; color:var(--muted); margin-top:6px; }
    .preview {
      width:100%; aspect-ratio: 16/10; background:#0b0c10; border:1px dashed #2a2f3a; border-radius:12px; overflow:hidden;
      display:grid; place-items:center;
    }
    video { width:100%; height:100%; object-fit: cover; }
    .jitsi-host { width:100%; height: calc(100vh - 140px); min-height:520px; border-radius:16px; overflow:hidden; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .status { margin-top:8px; font-size:12px; color:var(--muted); }
    .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; background:#0f1115; border:1px solid #2a2f3a; }
    .linkbox { display:flex; gap:8px; margin-top: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Ubuntu Mono", Consolas, monospace; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .jitsi-host{ height: 70vh; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Certified Consultation Call — Chikitsak Embed</h1>
    <div class="grid">
      <!-- LEFT: Pre-join card -->
      <div class="card" id="prejoin-card">
        <h2>Pre-Join Setup</h2>

        <label for="displayName">Your name</label>
        <input id="displayName" type="text" placeholder="Type your intimidating alias" />

        <label for="roomName">Room name (optional)</label>
        <input id="roomName" type="text" placeholder="auto-generated if empty" />

        <div class="row">
          <div style="flex:1">
            <label for="cameraSelect">Camera</label>
            <select id="cameraSelect"></select>
          </div>
          <div style="flex:1">
            <label for="micSelect">Microphone</label>
            <select id="micSelect"></select>
          </div>
        </div>

        <div class="toggles">
          <label class="chip"><input type="checkbox" id="startMutedAudio" /> Start muted (mic)</label>
          <label class="chip"><input type="checkbox" id="startMutedVideo" /> Start camera off</label>
          <label class="chip"><input type="checkbox" id="lowBandwidth" /> Low bandwidth (SD)</label>
        </div>

        <label>Live preview</label>
        <div class="preview"><video id="preview" autoplay playsinline muted></video></div>

        <div class="row" style="margin-top:12px">
          <button class="btn good" id="btnPreview">Enable preview</button>
          <button class="btn primary" id="btnJoin" disabled>Join meeting</button>
        </div>
        <div class="hint">
          If device pickers are empty, click <b>Enable preview</b> to grant camera/mic permission first.
        </div>

        <div class="status" id="prejoinStatus">Idle.</div>
      </div>

      <!-- RIGHT: Meeting area -->
      <div class="card">
        <h2>Meeting</h2>
        <div id="jitsi" class="jitsi-host"></div>

        <div class="toolbar">
          <button class="btn" id="btnMute">Mute / Unmute</button>
          <button class="btn" id="btnCam">Camera On / Off</button>
          <button class="btn" id="btnScreen">Share Screen</button>
          <button class="btn" id="btnChat">Toggle Chat</button>
          <button class="btn" id="btnTiles">Tile View</button>
          <button class="btn" id="btnHand">Raise / Lower Hand</button>
          <button class="btn danger" id="btnLeave">Leave</button>
        </div>

        <div class="linkbox" style="flex-direction:column; align-items:stretch">
          <div style="display:flex; gap:8px; align-items:center">
            <input id="shareLink" class="mono" type="text" readonly />
            <button class="btn" id="btnCopy">Copy Jitsi</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:8px">
            <input id="shareAppLink" class="mono" type="text" readonly />
            <button class="btn" id="btnCopyApp">Copy App Link</button>
          </div>
        </div>

        <div class="status">
          <span class="pill" id="confState">Not connected</span>
          <span class="pill" id="participantCount">Participants: 0</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== Small helper for DOM ======
    const $ = (id) => document.getElementById(id);
    const status = (text) => { $("prejoinStatus").textContent = text; };

    // ====== State ======
    let previewStream = null;
    let jitsiApi = null;
    let currentRoom = null;

    function randomRoom() {
      return "demo-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 8);
    }

    // ====== Device handling & preview ======
    async function enablePreview() {
      try {
        status("Requesting camera/microphone permission…");
        // Initial constraints: 720p default; can flip to SD later.
        const useSD = $("lowBandwidth").checked;
        const constraints = {
          video: { width: useSD ? { ideal: 640 } : { ideal: 1280 }, height: useSD ? { ideal: 360 } : { ideal: 720 } },
          audio: true
        };
        previewStream = await navigator.mediaDevices.getUserMedia(constraints);
        const vid = $("preview");
        vid.srcObject = previewStream;

        // Populate device pickers
        await populateDeviceSelectors();
        $("btnJoin").disabled = false;
        status("Preview active. Adjust devices, then Join.");
      } catch (err) {
        console.error(err);
        status("Permission failed: " + (err && err.message ? err.message : err));
        $("btnJoin").disabled = true;
      }
    }

    async function populateDeviceSelectors() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      const mics = devices.filter(d => d.kind === "audioinput");

      const camSel = $("cameraSelect");
      const micSel = $("micSelect");
      camSel.innerHTML = ""; micSel.innerHTML = "";

      for (const c of cams) {
        const opt = document.createElement("option");
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${camSel.length + 1}`;
        camSel.appendChild(opt);
      }
      for (const m of mics) {
        const opt = document.createElement("option");
        opt.value = m.deviceId;
        opt.textContent = m.label || `Microphone ${micSel.length + 1}`;
        micSel.appendChild(opt);
      }

      // Try to select current preview tracks if labels exist
      if (previewStream) {
        const vt = previewStream.getVideoTracks()[0];
        const at = previewStream.getAudioTracks()[0];
        if (vt && vt.getSettings && vt.getSettings().deviceId) {
          camSel.value = vt.getSettings().deviceId;
        }
        if (at && at.getSettings && at.getSettings().deviceId) {
          micSel.value = at.getSettings().deviceId;
        }
      }
    }

    // ====== Join meeting ======
    function joinMeeting() {
      if (jitsiApi) { jitsiApi.dispose(); jitsiApi = null; }

      const name = $("displayName").value.trim() || "Nameless heathen";
      currentRoom = ($("roomName").value.trim() || randomRoom()).replace(/\s+/g, "-");
      const startMutedAudio = $("startMutedAudio").checked;
      const startMutedVideo = $("startMutedVideo").checked;
      const lowBW = $("lowBandwidth").checked;

      const domain = "meet.jit.si";
      const options = {
        roomName: currentRoom,
        parentNode: $("jitsi"),
        width: "100%",
        height: "100%",
        userInfo: { displayName: name },
        configOverwrite: {
          disableDeepLinking: true,
          prejoinPageEnabled: false,            // We already did our own pre-join
          startWithAudioMuted: startMutedAudio,
          startWithVideoMuted: startMutedVideo,
          // Lower bandwidth mode if requested
          resolution: lowBW ? 360 : 720,
          constraints: {
            video: { height: { ideal: lowBW ? 360 : 720 } }
          },
          enableClosePage: true
        },
        interfaceConfigOverwrite: {
          // Keep it clean, only the essentials
          TOOLBAR_BUTTONS: [
            "microphone","camera","desktop","chat","raisehand",
            "tileview","videobackgroundblur","shortcuts","hangup","settings"
          ],
          SHOW_JITSI_WATERMARK: true
        }
      };

      jitsiApi = new JitsiMeetExternalAPI(domain, options);

      // Set devices (if selected) after API is ready
      const camId = $("cameraSelect").value;
      const micId = $("micSelect").value;

      jitsiApi.addEventListener("videoConferenceJoined", async (evt) => {
        $("confState").textContent = `Connected as ${name}`;
        $("participantCount").textContent = "Participants: " + (evt?.participantId ? 1 : "1");
        $("shareLink").value = `https://meet.jit.si/${currentRoom}`;

        // Try to switch to chosen devices
        if (camId) jitsiApi.executeCommand("setVideoInputDevice", camId);
        if (micId) jitsiApi.executeCommand("setAudioInputDevice", micId);
      });

      jitsiApi.addEventListener("participantJoined", (p) => {
        updateCount();
      });
      jitsiApi.addEventListener("participantLeft", (p) => {
        updateCount();
      });
      jitsiApi.addEventListener("videoConferenceLeft", () => {
        $("confState").textContent = "Left meeting";
        $("participantCount").textContent = "Participants: 0";
      });

      // Wire external controls
      $("btnMute").onclick  = () => jitsiApi.executeCommand("toggleAudio");
      $("btnCam").onclick   = () => jitsiApi.executeCommand("toggleVideo");
      $("btnScreen").onclick= () => jitsiApi.executeCommand("toggleScreenSharing");
      $("btnChat").onclick  = () => jitsiApi.executeCommand("toggleChat");
      $("btnTiles").onclick = () => jitsiApi.executeCommand("toggleTileView");
      $("btnHand").onclick  = () => jitsiApi.executeCommand("toggleRaiseHand");
      $("btnLeave").onclick = () => jitsiApi.executeCommand("hangup");

      // Clean preview tracks after joining
      stopPreview();
      status("Joined room: " + currentRoom);
      $("shareLink").value = `https://meet.jit.si/${currentRoom}`;
    }

    function updateCount() {
      if (!jitsiApi) return;
      jitsiApi.getParticipantsInfo().then(list => {
        $("participantCount").textContent = "Participants: " + (list?.length ?? 1);
      }).catch(()=>{ /* ignore */ });
    }

    function stopPreview() {
      if (previewStream) {
        previewStream.getTracks().forEach(t => t.stop());
        previewStream = null;
        $("preview").srcObject = null;
      }
    }

    // ====== Clipboard ======
    $("btnCopy").onclick = async () => {
      try {
        await navigator.clipboard.writeText($("shareLink").value);
        $("btnCopy").textContent = "Copied";
        setTimeout(() => $("btnCopy").textContent = "Copy link", 1200);
      } catch {
        $("shareLink").select();
        document.execCommand("copy");
      }
    };
    $("btnCopyApp").onclick = async () => {
      try {
        await navigator.clipboard.writeText($("shareAppLink").value);
        $("btnCopyApp").textContent = "Copied";
        setTimeout(() => $("btnCopyApp").textContent = "Copy App Link", 1200);
      } catch {
        $("shareAppLink").select();
        document.execCommand("copy");
      }
    };

    // ====== Bind buttons ======
    $("btnPreview").onclick = enablePreview;
    $("btnJoin").onclick = joinMeeting;

    // Try to kick off preview on load (browsers may block; the button is backup)
    window.addEventListener("DOMContentLoaded", async () => {
      try { await enablePreview(); } catch { /* user gesture will be needed */ }

      // Support URL params: ?room=xxx&name=yyy&autojoin=1&muted=1&video=0
      const params = new URLSearchParams(location.search);
      const roomParam = params.get('room');
      const nameParam = params.get('name');
      const auto = params.get('autojoin');
      const muted = params.get('muted');
      const video = params.get('video');
      if (roomParam) { $("roomName").value = roomParam; }
      if (nameParam) { $("displayName").value = decodeURIComponent(nameParam); }
      if (muted === '1') { $("startMutedAudio").checked = true; }
      if (video === '0') { $("startMutedVideo").checked = true; }
      // Pre-fill share links so they are visible immediately
      if (roomParam) {
        $("shareLink").value = `https://meet.jit.si/${roomParam}`;
        $("shareAppLink").value = `${location.origin}/jitsi-demo.html?room=${roomParam}&autojoin=1`;
      }
      if (auto === '1') {
        // wait a tick for preview/devices, then join
        setTimeout(() => { joinMeeting(); }, 300);
      }
    });

    // Toggling SD/HD re-requests preview constraints for accuracy
    $("lowBandwidth").addEventListener("change", async () => {
      stopPreview();
      try { await enablePreview(); } catch {}
    });

    // Re-list devices when permissions change (some browsers)
    navigator.mediaDevices?.addEventListener?.("devicechange", populateDeviceSelectors);
  </script>
</body>
</html>
